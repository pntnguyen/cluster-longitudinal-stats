# GEE and GLMM for binary outcome

## Summary GEE and LMM for continuous outcomes

## Data

Data from a longitudinal study of adolescents in the state of Victoria carried out between August 1992 and July 1995. Approximately 2,000 adolescents were recruited and followed up at six timepoints (“waves”) at six-monthly intervals. Some of the participants were not recruited until the second wave

We will focus on one of the smoking measures: regular smoking. Smoking behaviour was determined at each wave using a 7-day retrospective diary, completed by all participants except those who considered themselves non-smokers or ex-smokers (no cigarette in the previous month). From the diary response, a subject was categorized as a “regular smoker” if they reported smoking on at least six days of the previous week.

We are interested in determining the prevalence of smoking for each gender and investigating how this changes with age. Secondary questions concern the association between the prevalence of smoking and baseline factors such as parental smoking.

|Variable name|Description|
|:------------|:----------|
|id|Participant identifier|
|age|Age of participant at survey wave (years)| 
|wave|Wave of data collection (1,2,…,6)|
|sex|Sex (0=male, 1=female)|
|parsmk|Parental smoking (1=at least one parent smokes most days, 0=otherwise)|
|regsmoke|Regular smoker (1=participant reports smoking at least 6 days a week, 0=otherwise)|

```{r}
library(foreign)
smoke_prev <- read.dta("data/smoke_prev.dta")
head(smoke_prev)
```

Label sex variable 

Before analysis, we should center variables by subtracting the sample mean from each observation because:

  - It makes the intercept more interpretable by creating a meaningful zero point; when the coefficient is negative, it is below the population mean, and when the coefficient is positive, it is above the population mean.  

```{r}
## centering age and wave variables
smoke_prev <- transform(smoke_prev, age_c = age - 16.2,wave_c = (wave - 3.5)/2)
```

```{r}
#| fig-width: 10
#| fig-height: 5
#| fig-cap: We can see the different in x and y axes

library(patchwork)
library(ggplot2)

p1 <-smoke_prev |> 
  ggplot(aes(x = wave, y = age))+
  geom_line(aes(group = id))+
  labs(title = "Before centering")

p2 <- smoke_prev |> 
  ggplot(aes(x = wave_c, y = age_c))+
  geom_line(aes(group = id))+
  labs(title = "After centering")

p1|p2
```

## Fitting normal logistic regression, ignoring within-subject correlation.

```{r}
glm.fit1 <- glm(regsmoke ~ sex*age_c, data = smoke_prev, family =binomial)
summary(glm.fit1)
```

Using `gtsummary` to create summary table, in this code we used `exponential = TRUE` to delog the odds ratio

```{r}
library(gtsummary)

glm.fit1 |> 
  tbl_regression(exponentiate = TRUE,
                 intercept = TRUE)
```


Interpret the coefficients

  - `Intercept`: the odds of being a regular smoker for the reference group (males) at the reference value of age (age_c = 0)

  -  `sex`: Difference in odds of regular smoking between females and males at age_c = 0

  - `age_c`: Change in odds of regular smoking per 1-unit increase in age (centered) among reference group ( sex = 0 = males)
  
  - `sex * age_c` : Difference in the age effect between males and females (effect modification)
  
To calculate the change in odds of regular smoking per 1-unit in age among females, we should take one step, using `esticon()` function

```{r}
library(doBy) 

esticon(glm.fit1, c(0, 0, 1, 1)) |> exp()
```

The logistic regression above is equaled model which directly gives both age effects for male and females

```{r}
glm.fit1.1 <- glm(regsmoke ~ sex+I(age_c*(sex=="male"))+I(age_c*(sex=="female")), 
                  data = smoke_prev, family =binomial)

summary(glm.fit1.1)
```

```{r}
glm.fit1.1 |> 
  tbl_regression(exponentiate = TRUE,
                 intercept = TRUE)

```

  - `Intercept`: the odds of being a regular smoker for the reference group (males) at the reference value of age (age_c = 0)

  -  `sex`: Difference in odds of regular smoking between males and females at age_c = 0

  - Coefficient at (third line): Change in odds of regular smoking per 1-unit increase in age (centered) among males
  
  -  Coefficient at (fourth line): Change in odds of regular smoking per 1-unit increase in age (centered) among females
  
## Incorporate correlation in outcome data: GEE

  - Unlike the normal distribution, binomial has no natural multivariate version, so full probability model approach to logistic regression is more challenging
  
  - However, as previously with continuous outcome, the *generalized estimating equations* produce unbiased coefficient estimates under certain conditions
  
  - Specify working correlation matrix and use robust variance estimates
  
```{r}
library(geepack); library(gee)

robglm.fit1 <- geeglm(regsmoke ~ sex*age_c, data = smoke_prev, family =binomial,id=id)
summary(robglm.fit1)
```
  
Compare with normal logistic regression

::: columns
::: {.column width="49%"}

GEE
  
```{r}
robglm.fit1 |> 
  tbl_regression(intercept = TRUE,
                 exponentiate = TRUE)
```

:::  

::: {.column width="2%"}

:::

::: {.column width="49%"}

Normal Linear regression

```{r}
glm.fit1 |> 
  tbl_regression(exponentiate = TRUE,
                 intercept = TRUE)
```

:::

:::

::: {.callout-note}

As shown, the coefficient estimates are identical, but the 95% confidence interval is wider and the p-value is larger for the sex coefficient compared with the standard logistic regression. By using robust variance estimation, GEE accounts for potential within-individual correlation and answers the question, “If observations within an individual are correlated, how uncertain should the estimates be?” These results suggest reduced effective information for time-invariant covariates.

:::
